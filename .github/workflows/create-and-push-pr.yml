on:
  push:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:

    - name: Check if update branch already exists
      id: check-existing-branch
      run: |
        set +o errexit
        git ls-remote --exit-code --heads "https://github.com/acoulton/actions-playground.git" "do-update"
        if [ $? -eq 0 ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "checkout_branch=do-update" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "checkout_branch=main" >> $GITHUB_OUTPUT
        fi

    - uses: actions/checkout@v4
      with:
        ref: ${{ steps.check-existing-branch.outputs.checkout_branch }}

    - name: Make a commit msg
      id: msg
      run: |
        {
          echo 'commit_msg<<ENDOFVAR'
          echo 'Do a commit'
          echo ''
          echo 'With multiple lines'
          echo 'ENDOFVAR'
        } >> $GITHUB_OUTPUT

    - name: No changes this time but branch exists
      id: changes
      run: |
        date=`date`
        echo $date >> test.txt
        echo "date=$date" >> $GITHUB_OUTPUT

    - name: Commit & push
      if: true
      env:
        GH_TOKEN: ${{ github.token }}
        BRANCH_NAME: do-update
        PR_EXISTS: ${{ steps.check-existing-branch.outputs.exists }}
        PR_TITLE: Do an automated thing ${{steps.changes.outputs.date}}
      run: .github/commit-and-push.sh
