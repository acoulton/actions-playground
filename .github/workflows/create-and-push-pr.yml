on:
  push:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:

    - name: Check if update branch already exists
      id: check-existing-branch
      uses: actions/github-script@v7
      with:
        script: |
          async function findBranchDetails() {
            const iterator = github.paginate.iterator(
              github.rest.pulls.list,
              {
                owner: 'acoulton',
                repo: 'actions-playground',
                state: 'open'
              }
            )
            for await (const response of iterator) {
              for (const pr of response.data) {
                if (pr.head.ref.startsWith('do-update-')) {
                  core.info(`Found existing PR ${pr.number} for ${pr.head.ref}`)
                  return {
                    exists: 'true',
                    checkout_branch: pr.head.ref,
                    commit_branch: pr.head.ref
                  }
                }
              }
            }

            const timestamp = Math.floor(Date.now() / 1000)
            const newBranch = `do-update-${timestamp}`
            core.info(`No existing PR - starting new branch ${newBranch}`)
            return {
              exists: 'false',
              checkout_branch: 'do-my-update',
              commit_branch: newBranch,
            }
          }

          const result = await findBranchDetails();
          core.setOutput('exists', result.exists)
          core.setOutput('checkout_branch', result.checkout_branch)
          core.setOutput('commit_branch', result.commit_branch)

    - run: |
        echo "Exists: ${{ steps.check-existing-branch.outputs.exists }}"
        echo "Checkout: ${{ steps.check-existing-branch.outputs.checkout_branch }}"
        echo "Checkout: ${{ steps.check-existing-branch.outputs.commit_branch }}"

    - uses: actions/checkout@v4
      with:
        ref: ${{ steps.check-existing-branch.outputs.checkout_branch }}

    - name: Make a commit msg
      id: msg
      run: |
        {
          echo 'commit_msg<<ENDOFVAR'
          echo 'Do a commit'
          echo ''
          echo 'With multiple lines'
          echo 'ENDOFVAR'
        } >> $GITHUB_OUTPUT

    - name: No changes this time but branch exists
      id: changes
      run: |
        date=`date`
        echo $date >> test.txt
        echo "date=$date" >> $GITHUB_OUTPUT

    - name: Commit & push
      if: true
      env:
        GH_TOKEN: ${{ github.token }}
        BRANCH_NAME: ${{ steps.check-existing-branch.outputs.commit_branch }}
        COMMIT_MSG: ${{ steps.msg.outputs.commit_msg }}
        PR_EXISTS: ${{ steps.check-existing-branch.outputs.exists }}
        PR_TITLE: Do an automated thing ${{steps.changes.outputs.date}}
      run: .github/commit-and-push.sh
