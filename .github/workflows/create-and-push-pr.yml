on:
  push:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:

    - name: Check if update branch already exists
      id: check-existing-branch
      uses: actions/github-script@v7
      with:
        script: |
          const iterator = github.paginate.iterator(
            github.rest.pulls.listForRepo,
            {
              owner: 'acoulton',
              repo: 'actions-playground',
              state: 'open'
            }
          )
          for await (const response of iterator) {
            for (const pr of response.data) {
              console.log(pr)
            }
          }

      run: |
        set +o errexit
        git ls-remote --exit-code --heads "https://github.com/acoulton/actions-playground.git" "do-update"
        if [ $? -eq 0 ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "checkout_branch=do-update" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "checkout_branch=do-my-update" >> $GITHUB_OUTPUT
        fi

    - uses: actions/checkout@v4
      with:
        ref: ${{ steps.check-existing-branch.outputs.checkout_branch }}

    - name: Make a commit msg
      id: msg
      run: |
        {
          echo 'commit_msg<<ENDOFVAR'
          echo 'Do a commit'
          echo ''
          echo 'With multiple lines'
          echo 'ENDOFVAR'
        } >> $GITHUB_OUTPUT

    - name: No changes this time but branch exists
      id: changes
      run: |
        date=`date`
        echo $date >> test.txt
        echo "date=$date" >> $GITHUB_OUTPUT

    - name: Commit & push
      if: false
      env:
        GH_TOKEN: ${{ github.token }}
        BRANCH_NAME: do-update
        COMMIT_MSG: ${{ steps.msg.outputs.commit_msg }}
        PR_EXISTS: ${{ steps.check-existing-branch.outputs.exists }}
        PR_TITLE: Do an automated thing ${{steps.changes.outputs.date}}
      run: .github/commit-and-push.sh
